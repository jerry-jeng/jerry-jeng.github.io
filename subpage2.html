<script type="module">
  window.sendMessage = async function () {
    const inputField = document.getElementById('userInput');
    const chatContainer = document.getElementById('chat-container');
    const sendBtn = document.getElementById('sendBtn');
    const question = inputField.value.trim();

    if (!question) return;

    appendMessage('user', question);
    inputField.value = '';
    sendBtn.disabled = true;

    const aiMsgDiv = appendMessage('ai', '思考中...');

    try {
      const response = await fetch("/api/gemini", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: question })
      });

      const data = await response.json();
      aiMsgDiv.innerText = data.text || "沒有回應";
    } catch (error) {
      aiMsgDiv.innerText = "抱歉，發生錯誤：" + error.message;
    } finally {
      sendBtn.disabled = false;
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
  };

  function appendMessage(sender, text) {
    const container = document.getElementById('chat-container');
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${sender}`;
    msgDiv.innerText = text;
    container.appendChild(msgDiv);
    container.scrollTop = container.scrollHeight;
    return msgDiv;
  }
</script>
